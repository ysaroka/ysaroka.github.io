var kp={hd:10,hd_:15,enr:30};var keys=['input[name="s%d"]:checked',"#r%dr","#r%de","#c%dr","#c%dh"];var limits=[2,100,100,999999,999999];var d1="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";var d2=",1234567890";var spent={reg:0,reg_:0,hd:0,hd_:0,enr:0,zeny:0,equip:0};var P;var rates=[];var which=[];var zeny=[];function serialize(g,h){var f,c,b;var a="";var e=[];for(b in kp){if(kp.hasOwnProperty(b)){e.push(kp[b])}}for(c=0;c<keys.length;++c){for(f=0;f<20;++f){var l=parseInt($(keys[c].replace("%d",f)).val(),10);if(!isNaN(l)&&l>0&&l<=limits[c]){e.push(l)}else{e.push("")}}}for(f=0;f<20;++f){e.push($("#f"+f).attr("checked")?"1":"")}e=g+","+e.join(",")+","+((h==0)?"":h);for(f=0;f<e.length/3;++f){var d=13*13*d2.indexOf(e.charAt(f*3))+13*d2.indexOf(e.charAt(f*3+1))+d2.indexOf(e.charAt(f*3+2));a+=(d1.charAt(Math.floor(d/52))+d1.charAt(d%52))}a=a.replace(/aaaaaaaaaa/g,"9");a=a.replace(/aaaaaaaaa/g,"8");a=a.replace(/aaaaaaaa/g,"7");a=a.replace(/aaaaaaa/g,"6");a=a.replace(/aaaaaa/g,"5");a=a.replace(/aaaaa/g,"4");a=a.replace(/aaaa/g,"3");a=a.replace(/aaa/g,"2");a=a.replace(/aa/g,"1");return"00"+a}function unserialize(a){var f,d,c,g;var e="";switch(a.substr(0,2)){case"00":g=keys.length;a=a.substr(2);break;default:g=4;break}a=a.replace(/9/g,"aaaaaaaaaa");a=a.replace(/8/g,"aaaaaaaaa");a=a.replace(/7/g,"aaaaaaaa");a=a.replace(/6/g,"aaaaaaa");a=a.replace(/5/g,"aaaaaa");a=a.replace(/4/g,"aaaaa");a=a.replace(/3/g,"aaaa");a=a.replace(/2/g,"aaa");a=a.replace(/1/g,"aa");for(f=0;f<a.length/2;++f){var h=d1.indexOf(a.charAt(f*2));h=h*52+d1.indexOf(a.charAt(f*2+1));e+=(d2.charAt(Math.floor(h/169))+d2.charAt(Math.floor((h%169)/13))+d2.charAt(h%13))}e=e.split(",");if(e.length==0){return}$("#target").val((e[0]=="")?"0":e[0]);var b=0;for(c in kp){if(kp.hasOwnProperty(c)){if(++b>=e.length){return}$("#kp_"+c).val(e[b])}}for(d=0;d<g;++d){for(f=0;f<20;++f){if(++b>=e.length){return}var l=e[b];if(!(d==2&&f>=10)&&l==""){l="0"}if(d==0){$("#s"+f+"_"+l).attr("checked","checked")}else{$(keys[d].replace("%d",f)).val(l)}}}for(f=0;f<20&&++b<e.length;++f){if(e[b]==1){$("#f"+f).attr("checked","checked")}else{$("#f"+f).removeAttr("checked")}}if(++b<e.length){$("#origin").val(e[b]==""?"0":e[b])}}function pp(f){var e=f.toString().split(".");var d=e[0];var b=(e.length>1)?e[1]:"";var a=d.length;b=b.substr(0,Math.max(0,Math.min(5,9-a)));if(a>9){d=d.substr(0,9)+d.substr(9).replace(/./g,"0")}var c=/(\d+)(\d{3})/;while(c.test(d)){d=d.replace(c,"$1,$2")}return d+(b.length>0?("."+b):"")}function getrange(d,c){var g=parseInt($(d).val(),10);var f=parseInt($(c).val(),10);if(isNaN(g)||isNaN(f)){return[]}g=Math.min(20,Math.max(0,g));f=Math.min(20,Math.max(1,f));if(g>f){var e=g;g=f;f=e}$(d).val(g);$(c).val(f);return[g,f]}function calcexpected(f,b){var c,a;var e=Matrix.I(f+1).subtract(P.minor(1,1,f+1,f+1));var d=svd(e);e=e.inv();if(d[d.length-1]<1e-16){d="too high"}else{d=d[0]/d[d.length-1];if(d>6000000000000000){d="too high"}}$("#resultdata").empty();for(a in spent){if(spent.hasOwnProperty(a)){spent[a]=0}}spent.equip=e.e(1,1);for(c=0;c<f;++c){spent.zeny+=zeny[c]*e.e(1,c+2);spent[which[c]+(((which[c]=="reg"||which[c]=="hd")&&c>=10)?"_":"")]+=e.e(1,c+2)}$("#resultdata").append('<tr><td class="num">'+pp(spent.reg)+'</td><td class="num">'+pp(spent.reg_)+'</td><td class="num">'+pp(spent.hd)+'</td><td class="num">'+pp(spent.hd_)+'</td><td class="num">'+pp(spent.enr)+'</td><td class="num">'+pp(spent.equip)+'</td><td class="num">'+pp(spent.zeny)+"</td></tr>\n");$("#resultsave").val("http://choobs.org/upgrade/expect.php?"+serialize(f,b));$("#resultsave").parent().show()}function buildP(d,a){var c;var e=d+2;P=Matrix.Zero(e,e);P.elements[e-1][e-1]=1;P.elements[0][a+1]=1;for(c=0;c<d;++c){P.elements[c+1][c+2]=rates[c]/100;var b;if($("#f"+c).attr("checked")){b=c+1}else{if(which[c]=="hd"){b=Math.max(1,c)}else{b=0}}P.elements[c+1][b]=(100-rates[c])/100}}function getparams(d){var c,b,a,f,e;for(c=0;c<d;++c){a=$('input[name="s'+c+'"]:checked').val();if(a&&/^0|1|2$/.test(a)){f=parseInt(a,10);b="#r"+c+"rre".charAt(f);e=parseInt($(b).val(),10);if(isNaN(e)||!(e>=1&&e<=100)){alert("не указаны процентные шансы для заточки с +"+c+" до +"+(c+1)+" с использованием "+["обычн./HD","обычн./HD","обогащенной"][f]+" руды");$(b).focus();return false}rates[c]=e;which[c]=["reg","hd","enr"][f];zeny[c]=parseInt($("#c"+c+"rhr".charAt(f)).val(),10);if(isNaN(zeny[c])||zeny[c]<0){zeny[c]=0}}else{alert("неверный выбор руды для заточки с +"+c+" до +"+(c+1));$("#s"+c+"_0").focus();return false}}for(b in kp){if(kp.hasOwnProperty(b)){a=parseInt($("#kp_"+b).val(),10);if(isNaN(a)){a=0;$("#kp_"+b).val(a)}kp[b]=a}}return true}function calc(){var b=getrange("#origin","#target");if(b.length!=2){alert("неверный диапазон заточки");return}var a=b[0];var c=b[1];if(!getparams(c)){return}buildP(c,a);calcexpected(c,a)}$(function(){$("#resultsave").parent().hide();$("#p_s_set").click(function(){var b;var c=$("#p_s").val();var a=getrange("#p_s_from","#p_s_to");if(a.length!=2){alert("invalid range");return}var e=a[0];var d=a[1];if(c==2&&d>10){d=10}for(b=e;b<d;++b){$("#s"+b+"_"+c).attr("checked","checked")}});$("#p_r_set").click(function(){var b;var a=$("#p_r").val();var c=presets[a];if(c){$("#kp_hd").val(10);$("#kp_hd_").val(15);$("#kp_enr").val(30);for(b=0;b<20;++b){$("#r"+b+"r").val(c[0][b]);if(b<10){$("#r"+b+"e").val(c[1][b])}$("#c"+b+"r").val(c[2][b]);$("#c"+b+"h").val(c[3][b])}}});$("#calc").click(calc);if(location.search.length>1){unserialize(decodeURI(location.search.substr(1)));calc()}else{if(typeof($("input:radio:checked").val())=="undefined"){$("#p_s_set").click();(function(){var a;for(a=10;a<20;++a){$("#s"+a+"_1").attr("checked","checked")}})()}}});function hypot(a,b){return Math.sqrt(a*a+b*b)}function svd(u){var E=u.rows();var D=u.cols();var w=[];var R=[];var C=[];var z=u.dup();var K=0,G=0,F=0,v;var h=Math.min(E-1,D);var q=Math.max(0,Math.min(D-2,E));for(F=0;F<Math.max(h,q);++F){if(F<h){w[F]=0;for(K=F;K<E;++K){w[F]=hypot(w[F],z.elements[K][F])}if(w[F]!=0){if(z.elements[F][F]<0){w[F]=-w[F]}for(K=F;K<E;++K){z.elements[K][F]/=w[F]}z.elements[F][F]+=1}w[F]=-w[F]}for(G=F+1;G<D;++G){if((F<h)&&(w[F]!=0)){v=0;for(K=F;K<E;++K){v+=z.elements[K][F]*z.elements[K][G]}v=-v/z.elements[F][F];for(K=F;K<E;++K){z.elements[K][G]+=v*z.elements[K][F]}}R[G]=z.elements[F][G]}if(F<q){R[F]=0;for(K=F+1;K<D;++K){R[F]=hypot(R[F],R[K])}if(R[F]!=0){if(R[F+1]<0){R[F]=-R[F]}for(K=F+1;K<D;++K){R[K]/=R[F]}R[F+1]+=1}R[F]=-R[F];if((F+1<E)&&(R[F]!=0)){for(K=F+1;K<E;++K){C[K]=0}for(G=F+1;G<D;++G){for(K=F+1;K<E;++K){C[K]+=R[G]*z.elements[K][G]}}for(G=F+1;G<D;++G){v=-R[G]/R[F+1];for(K=F+1;K<E;++K){z.elements[K][G]+=v*C[K]}}}}}var B=Math.min(D,E+1);if(h<D){w[h]=z.elements[h][h]}if(E<B){w[B-1]=0}if(q+1<B){R[q]=z.elements[q][B-1]}R[B-1]=0;var H=B-1;var J=0;var x=Math.pow(2,-52);var d=Math.pow(2,-966);while(B>0){F=0;var y=0;for(F=B-2;F>=-1;--F){if(F==-1){break}if(Math.abs(R[F])<=d+x*(Math.abs(w[F])+Math.abs(w[F+1]))){R[F]=0;break}}if(F==B-2){y=4}else{var W;for(W=B-1;W>=F;--W){if(W==F){break}v=(W!=B?Math.abs(R[W]):0)+(W!=F+1?Math.abs(R[W-1]):0);if(Math.abs(w[W])<=d+x*v){w[W]=0;break}}if(W==F){y=3}else{if(W==B-1){y=1}else{y=2;F=W}}}++F;var Q,r,O;switch(y){case 1:Q=R[B-2];R[B-2]=0;for(G=B-2;G>=F;--G){v=hypot(w[G],Q);r=w[G]/v;O=Q/v;w[G]=v;if(G!=F){Q=-O*R[G-1];R[G-1]=r*R[G-1]}}break;case 2:Q=R[F-1];R[F-1]=0;for(G=F;G<B;++G){v=hypot(w[G],Q);r=w[G]/v;O=Q/v;w[G]=v;Q=-O*R[G];R[G]=r*R[G]}break;case 3:var V=Math.max(Math.max(Math.max(Math.max(Math.abs(w[B-1]),Math.abs(w[B-2])),Math.abs(R[B-2])),Math.abs(w[F])),Math.abs(R[F]));var I=w[B-1]/V;var o=w[B-2]/V;var a=R[B-2]/V;var S=w[F]/V;var l=R[F]/V;var U=((o+I)*(o-I)+a*a)/2;var T=(I*a)*(I*a);var L=0;if((U!=0)||(T!=0)){L=Math.sqrt(U*U+T);if(U<0){L=-L}L=T/(U+L)}Q=(S+I)*(S-I)+L;var N=S*l;for(G=F;G<B-1;G++){v=hypot(Q,N);r=Q/v;O=N/v;if(G!=F){R[G-1]=v}Q=r*w[G]+O*R[G];R[G]=r*R[G]-O*w[G];N=O*w[G+1];w[G+1]=r*w[G+1];v=hypot(Q,N);r=Q/v;O=N/v;w[G]=v;Q=r*R[G]+O*w[G+1];w[G+1]=-O*R[G]+r*w[G+1];N=O*R[G+1];R[G+1]=r*R[G+1]}R[B-2]=Q;++J;break;case 4:if(w[F]<=0){w[F]=(w[F]<0?-w[F]:0)}while(F<H){if(w[F]>=w[F+1]){break}v=w[F];w[F]=w[F+1];w[F+1]=v;++F}J=0;--B;break}}return w};
